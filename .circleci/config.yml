version: 2.1
orbs:
  eb: circleci/aws-elastic-beanstalk@1.0.0
jobs:
  build-docker:
    machine: true
    steps:
      - checkout
      - run:
          name: Building Docker Image
          command: |
            docker build -t udayshankarsingh/koala-backend:dn-<<pipeline.number>> .
      - run:
          name: Pushing image to dockerhub
          command: |
            docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASSWORD
            docker push udayshankarsingh/koala-backend:dn-<<pipeline.number>>
  eb-deploy:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - checkout
      - eb/setup
      - run:
          command: |
            eb use koala-$CIRCLE_BRANCH
            eb status
          name: You may now use the EB CLI within this job
      - run:
          name: Deploying docker image
          command: |
            echo "This is pipeline ID - "<<pipeline.number>>
            sed -i'' -e "s;%BUILD_NUM%;<<pipeline.number>>;g" ./.deploy/Dockerrun.aws.json
            eb deploy
#  eb/deploy:
#    docker:
#      - image: 'udayshankarsingh/koala-backend:born'
#        auth:
#          username: $DOCKERHUB_USERNAME
#          password: $DOCKERHUB_PASSWORD
#    steps:
#      - checkout
#      - run:
#          name: Printing some basic env variables to validate their pick-ups
#          command: |
#            echo $AWS_DEFAULT_REGION
#            echo $CIRCLE_BRANCH
#      - run:
#          name: Deploying docker image
#          command: |
#            docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASSWORD
#            sed -i'' -e "s;%BUILD_NUM%;dn-<<pipeline.number>>;g" Dockerrun.aws.json
#            eb use $CIRCLE_BRANCH
#            eb deploy -l dn-<<pipeline.number>>
workflows:
  version: 2
  elastic-beanstalk-workflow:
    jobs:
      - build-docker:
          filters:
            branches:
              only: staging
      - eb-deploy:
          filters:
            branches:
              only: staging
          requires:
            - build-docker
#      - eb/deploy:
#          context: aws-creds
#          environment-name: $CIRCLE_BRANCH
#          filters:
#            branches:
#              only:
#                - staging
#          label: version-<<pipeline.number>>
#          requires:
#            - build-pragaty-docker

